<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geschichts-Quiz | Deutsche Geschichte</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0066CC;
            --primary-dark: #001E44;
            --primary-light: #4D94DB;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f39c12;
            --bg-gradient: linear-gradient(135deg, #001E44 0%, #003366 50%, #0066CC 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #1a1a2e;
            --text-light: #ffffff;
            --shadow: 0 10px 40px rgba(0, 30, 68, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans Pro', sans-serif; background: var(--bg-gradient); min-height: 100vh; color: var(--text-dark); overflow-x: hidden; }
        .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.1; background-image: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 0%, transparent 50%); }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card-bg); border-radius: 20px; padding: 50px 40px; box-shadow: var(--shadow); width: 100%; max-width: 420px; text-align: center; animation: fadeInUp 0.8s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .login-icon { width: 80px; height: 80px; background: var(--bg-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; font-size: 36px; }
        .login-card h1 { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--primary-dark); margin-bottom: 8px; }
        .login-card .subtitle { color: #666; margin-bottom: 30px; font-size: 15px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-dark); font-size: 14px; }
        .input-group input { width: 100%; padding: 14px 18px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; }
        .input-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1); }
        .btn { background: var(--bg-gradient); color: white; border: none; padding: 16px 40px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; width: 100%; text-transform: uppercase; letter-spacing: 1px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 102, 204, 0.4); }
        .btn:active { transform: translateY(0); }
        .error-message { color: var(--error); font-size: 14px; margin-top: 15px; display: none; }
        header { background: var(--card-bg); border-radius: 15px; padding: 25px 30px; margin-bottom: 25px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-left h1 { font-family: 'Playfair Display', serif; font-size: 24px; color: var(--primary-dark); }
        .header-left .welcome { color: #666; font-size: 14px; margin-top: 4px; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .daily-plays { background: var(--primary-light); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .btn-logout { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 8px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-logout:hover { background: var(--primary); color: white; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .nav-tab { background: rgba(255,255,255,0.9); border: none; padding: 14px 28px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; color: var(--primary-dark); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-tab:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .nav-tab.active { background: var(--bg-gradient); color: white; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 30px; box-shadow: var(--shadow); margin-bottom: 25px; animation: fadeInUp 0.5s ease-out; }
        .card h2 { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--primary-dark); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .rounds-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .round-card { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .round-card:hover:not(.completed) { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0, 102, 204, 0.2); }
        .round-card.completed { border-color: var(--success); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
        .round-card .round-number { font-size: 13px; color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .round-card .round-title { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--primary-dark); margin-bottom: 12px; }
        .round-card .round-date { font-size: 13px; color: #666; }
        .round-card .round-status { position: absolute; top: 15px; right: 15px; font-size: 20px; }
        .round-card .score-badge { margin-top: 12px; display: inline-block; background: var(--success); color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .round-card .difficulty { margin-top: 10px; font-size: 12px; color: #888; }
        .difficulty-dots { display: inline-flex; gap: 3px; margin-left: 5px; }
        .difficulty-dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; }
        .difficulty-dot.active { background: var(--warning); }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .quiz-info { display: flex; gap: 20px; flex-wrap: wrap; }
        .quiz-stat { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 10px 20px; border-radius: 10px; text-align: center; }
        .quiz-stat .label { font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .quiz-stat .value { font-size: 20px; font-weight: 700; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-bottom: 30px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 10px; transition: width 0.5s ease; }
        .quiz-instruction { text-align: center; color: #666; margin-bottom: 25px; font-size: 15px; line-height: 1.6; }
        .quiz-instruction strong { color: var(--primary-dark); }
        .events-container { min-height: 300px; }
        .event-item { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 2px solid #e2e8f0; border-radius: 12px; padding: 18px 24px; margin-bottom: 12px; cursor: grab; transition: all 0.3s ease; display: flex; align-items: center; gap: 15px; user-select: none; }
        .event-item:hover { border-color: var(--primary); box-shadow: 0 4px 15px rgba(0, 102, 204, 0.15); }
        .event-item:active { cursor: grabbing; transform: scale(1.02); box-shadow: 0 8px 25px rgba(0, 102, 204, 0.25); }
        .event-item.dragging { opacity: 0.5; }
        .event-item .drag-handle { color: #94a3b8; font-size: 20px; }
        .event-item .event-number { width: 36px; height: 36px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0; }
        .event-item .event-text { flex: 1; font-size: 15px; line-height: 1.4; color: var(--primary-dark); }
        .event-item.correct { border-color: var(--success); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
        .event-item.correct .event-number { background: var(--success); }
        .event-item.incorrect { border-color: var(--error); background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        .event-item.incorrect .event-number { background: var(--error); }
        .quiz-actions { margin-top: 30px; text-align: center; }
        .quiz-actions .btn { max-width: 300px; }
        .result-card { text-align: center; padding: 40px; }
        .result-icon { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; font-size: 50px; }
        .result-icon.success { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); }
        .result-icon.partial { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .result-icon.fail { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
        .result-title { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--primary-dark); margin-bottom: 10px; }
        .result-subtitle { color: #666; margin-bottom: 25px; }
        .result-stars { font-size: 40px; margin-bottom: 20px; }
        .result-details { background: #f8fafc; border-radius: 12px; padding: 25px; margin: 25px 0; }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .result-row:last-child { border-bottom: none; font-weight: 700; font-size: 18px; color: var(--primary-dark); }
        .correct-order { margin-top: 30px; text-align: left; }
        .correct-order h3 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--primary-dark); margin-bottom: 15px; text-align: center; }
        .correct-item { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid var(--success); border-radius: 10px; padding: 14px 20px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        .correct-item .number { width: 32px; height: 32px; background: var(--success); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0; }
        .correct-item .event-name { flex: 1; font-weight: 600; color: var(--primary-dark); }
        .correct-item .event-date { color: var(--success); font-weight: 700; font-size: 14px; }
        .leaderboard-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .leaderboard-table th { background: var(--primary-dark); color: white; padding: 14px 16px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .leaderboard-table th:first-child { border-radius: 10px 0 0 10px; }
        .leaderboard-table th:last-child { border-radius: 0 10px 10px 0; }
        .leaderboard-table td { background: #f8fafc; padding: 16px; font-size: 14px; }
        .leaderboard-table tr td:first-child { border-radius: 10px 0 0 10px; }
        .leaderboard-table tr td:last-child { border-radius: 0 10px 10px 0; }
        .leaderboard-table .rank { font-weight: 700; color: var(--primary); font-size: 16px; }
        .leaderboard-table .rank-1 { color: #fbbf24; }
        .leaderboard-table .rank-2 { color: #94a3b8; }
        .leaderboard-table .rank-3 { color: #d97706; }
        .leaderboard-table .username { font-weight: 600; color: var(--primary-dark); }
        .leaderboard-table .current-user td { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            header { flex-direction: column; text-align: center; }
            .header-right { width: 100%; justify-content: center; }
            .nav-tabs { justify-content: center; }
            .nav-tab { padding: 12px 20px; font-size: 14px; }
            .card { padding: 20px; }
            .quiz-info { width: 100%; justify-content: center; }
            .leaderboard-table { font-size: 12px; }
            .leaderboard-table th, .leaderboard-table td { padding: 10px 8px; }
            .correct-item { flex-wrap: wrap; }
            .correct-item .event-date { width: 100%; margin-left: 47px; margin-top: 5px; }
        }
        .hidden { display: none !important; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--primary-dark); color: white; padding: 16px 24px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); z-index: 1000; animation: slideIn 0.3s ease-out; }
        .toast.error { background: var(--error); }
        .toast.success { background: var(--success); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .info-box { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .info-box p { color: var(--primary-dark); font-size: 14px; line-height: 1.5; }
        .attempt-badge { display: inline-block; background: var(--primary); color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-icon">üèõÔ∏è</div>
            <h1>Geschichts-Quiz</h1>
            <p class="subtitle">Teste dein Wissen √ºber deutsche Geschichte</p>
            <form id="loginForm">
                <div class="input-group">
                    <label for="username">Benutzername</label>
                    <input type="text" id="username" placeholder="Dein Name" required autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="password">Passwort</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn">Anmelden</button>
                <p class="error-message" id="loginError">Falsches Passwort. Bitte versuche es erneut.</p>
            </form>
        </div>
    </div>
    <div id="mainApp" class="container hidden">
        <header>
            <div class="header-left">
                <h1>üèõÔ∏è Geschichts-Quiz</h1>
                <p class="welcome">Willkommen, <span id="displayName">Spieler</span></p>
            </div>
            <div class="header-right">
                <span class="daily-plays" id="dailyPlays">Heute: 0/3 Runden</span>
                <button class="btn-logout" onclick="logout()">Abmelden</button>
            </div>
        </header>
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('rounds')">üìã Meine Runden</button>
            <button class="nav-tab" onclick="showSection('leaderboard')">üèÜ Rangliste</button>
        </nav>
        <div id="roundsSection" class="card">
            <h2>üìã Deine heutigen Runden</h2>
            <div class="info-box">
                <p>Jeden Tag erh√§ltst du <strong>3 neue Runden</strong> mit je <strong>3 verschiedenen Durchl√§ufen</strong>.<br>
                Jeder Durchlauf hat <strong>5 andere historische Ereignisse</strong> zum Sortieren!</p>
            </div>
            <div class="rounds-grid" id="roundsGrid"></div>
        </div>
        <div id="quizSection" class="card hidden">
            <div class="quiz-header">
                <div><h2 id="quizTitle">Runde 1</h2></div>
                <div class="quiz-info">
                    <div class="quiz-stat"><div class="label">Durchlauf</div><div class="value" id="attemptNumber">1/3</div></div>
                    <div class="quiz-stat"><div class="label">Punkte</div><div class="value" id="currentPoints">0</div></div>
                </div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 33%"></div></div>
            <div class="quiz-instruction">
                <span class="attempt-badge" id="attemptBadge">Durchlauf 1 von 3</span><br>
                <strong>Aufgabe:</strong> Bringe die historischen Ereignisse in die richtige chronologische Reihenfolge.<br>
                Ziehe die Ereignisse an die richtige Position (√§ltestes zuerst, neuestes zuletzt).
            </div>
            <div class="events-container" id="eventsContainer"></div>
            <div class="quiz-actions"><button class="btn" onclick="submitAnswer()">Antwort pr√ºfen</button></div>
        </div>
        <div id="resultSection" class="card hidden">
            <div class="result-card">
                <div class="result-icon" id="resultIcon">‚≠ê</div>
                <h2 class="result-title" id="resultTitle">Durchlauf beendet!</h2>
                <p class="result-subtitle" id="resultSubtitle"></p>
                <div class="result-stars" id="resultStars">‚≠ê‚≠ê‚≠ê</div>
                <div class="result-details">
                    <div class="result-row"><span>Korrekte Reihenfolge</span><span id="correctCount">3/5</span></div>
                    <div class="result-row"><span>Erstes Ereignis richtig</span><span id="firstBonus">+1</span></div>
                    <div class="result-row"><span>Letztes Ereignis richtig</span><span id="lastBonus">+1</span></div>
                    <div class="result-row"><span>Punkte dieser Durchlauf</span><span id="attemptPoints">5</span></div>
                </div>
                <div class="correct-order"><h3>‚úì Richtige Reihenfolge</h3><div id="correctOrderList"></div></div>
                <div class="quiz-actions" style="margin-top: 30px;"><button class="btn" id="continueBtn" onclick="continueQuiz()">Weiter</button></div>
            </div>
        </div>
        <div id="finalResultSection" class="card hidden">
            <div class="result-card">
                <div class="result-icon success" id="finalResultIcon">üèÜ</div>
                <h2 class="result-title">Runde abgeschlossen!</h2>
                <p class="result-subtitle" id="finalResultSubtitle"></p>
                <div class="result-details">
                    <div class="result-row"><span>Durchlauf 1</span><span id="attempt1Score">0 Punkte</span></div>
                    <div class="result-row"><span>Durchlauf 2</span><span id="attempt2Score">0 Punkte</span></div>
                    <div class="result-row"><span>Durchlauf 3</span><span id="attempt3Score">0 Punkte</span></div>
                    <div class="result-row"><span>Gesamtpunkte</span><span id="totalRoundScore">0 Punkte</span></div>
                </div>
                <div class="quiz-actions"><button class="btn" onclick="backToRounds()">Zur√ºck zur √úbersicht</button></div>
            </div>
        </div>
        <div id="leaderboardSection" class="card hidden">
            <h2>üèÜ Rangliste - Top 50</h2>
            <div style="overflow-x: auto;">
                <table class="leaderboard-table">
                    <thead><tr><th>Rang</th><th>Spieler</th><th>Punkte</th><th>Runden</th><th>√ò Punkte</th></tr></thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const CORRECT_PASSWORD = 'SvenFelix2025';
        const MAX_DAILY_ROUNDS = 3;
        const POINTS_PER_CORRECT = 3;
        const BONUS_FIRST_LAST = 1;
        const MAX_POINTS_PER_ROUND = 15;

        // Jede Runde hat 3 Durchl√§ufe mit je 5 VERSCHIEDENEN Ereignissen (= 15 Ereignisse pro Runde)
        const allQuizRounds = [
            {
                id: 1, title: "Weimarer Republik 1919-1933", category: "Weimarer Republik", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Spartakusaufstand in Berlin", date: "5.-12. Januar 1919" },
                        { id: 2, text: "Ermordung von Rosa Luxemburg und Karl Liebknecht", date: "15. Januar 1919" },
                        { id: 3, text: "Kapp-Putsch in Berlin", date: "13. M√§rz 1920" },
                        { id: 4, text: "Ermordung von Walther Rathenau", date: "24. Juni 1922" },
                        { id: 5, text: "Hitler-Putsch in M√ºnchen", date: "8./9. November 1923" }
                    ]},
                    { events: [
                        { id: 1, text: "Einf√ºhrung der Rentenmark", date: "15. November 1923" },
                        { id: 2, text: "Dawes-Plan tritt in Kraft", date: "1. September 1924" },
                        { id: 3, text: "Vertr√§ge von Locarno unterzeichnet", date: "16. Oktober 1925" },
                        { id: 4, text: "Deutschland tritt dem V√∂lkerbund bei", date: "8. September 1926" },
                        { id: 5, text: "Kellogg-Briand-Pakt unterzeichnet", date: "27. August 1928" }
                    ]},
                    { events: [
                        { id: 1, text: "Schwarzer Freitag erreicht Deutschland", date: "25. Oktober 1929" },
                        { id: 2, text: "Br√ºning wird Reichskanzler", date: "30. M√§rz 1930" },
                        { id: 3, text: "Franz von Papen wird Reichskanzler", date: "1. Juni 1932" },
                        { id: 4, text: "Kurt von Schleicher wird Reichskanzler", date: "3. Dezember 1932" },
                        { id: 5, text: "Adolf Hitler wird Reichskanzler", date: "30. Januar 1933" }
                    ]}
                ]
            },
            {
                id: 2, title: "NS-Machtergreifung", category: "NS-Zeit", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Reichstagsbrand in Berlin", date: "27. Februar 1933" },
                        { id: 2, text: "Reichstagsbrandverordnung", date: "28. Februar 1933" },
                        { id: 3, text: "Erm√§chtigungsgesetz verabschiedet", date: "23. M√§rz 1933" },
                        { id: 4, text: "B√ºcherverbrennung in Berlin", date: "10. Mai 1933" },
                        { id: 5, text: "Verbot aller Parteien au√üer NSDAP", date: "14. Juli 1933" }
                    ]},
                    { events: [
                        { id: 1, text: "R√∂hm-Putsch - Ermordung der SA-F√ºhrung", date: "30. Juni 1934" },
                        { id: 2, text: "Tod Hindenburgs - Hitler wird F√ºhrer", date: "2. August 1934" },
                        { id: 3, text: "Saarabstimmung - R√ºckkehr ins Reich", date: "13. Januar 1935" },
                        { id: 4, text: "Einf√ºhrung der allgemeinen Wehrpflicht", date: "16. M√§rz 1935" },
                        { id: 5, text: "N√ºrnberger Rassengesetze verk√ºndet", date: "15. September 1935" }
                    ]},
                    { events: [
                        { id: 1, text: "Besetzung des Rheinlands", date: "7. M√§rz 1936" },
                        { id: 2, text: "Olympische Spiele in Berlin", date: "1.-16. August 1936" },
                        { id: 3, text: "Anschluss √ñsterreichs", date: "12. M√§rz 1938" },
                        { id: 4, text: "M√ºnchner Abkommen", date: "30. September 1938" },
                        { id: 5, text: "Reichspogromnacht", date: "9./10. November 1938" }
                    ]}
                ]
            },
            {
                id: 3, title: "Zweiter Weltkrieg - Beginn", category: "Zweiter Weltkrieg", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Hitler-Stalin-Pakt unterzeichnet", date: "23. August 1939" },
                        { id: 2, text: "Deutscher √úberfall auf Polen", date: "1. September 1939" },
                        { id: 3, text: "Kriegserkl√§rung Gro√übritanniens", date: "3. September 1939" },
                        { id: 4, text: "Sowjetischer Einmarsch in Ostpolen", date: "17. September 1939" },
                        { id: 5, text: "Kapitulation Polens", date: "6. Oktober 1939" }
                    ]},
                    { events: [
                        { id: 1, text: "Deutsche Besetzung D√§nemarks und Norwegens", date: "9. April 1940" },
                        { id: 2, text: "Beginn des Westfeldzugs", date: "10. Mai 1940" },
                        { id: 3, text: "Evakuierung von D√ºnkirchen beginnt", date: "26. Mai 1940" },
                        { id: 4, text: "Deutsche Truppen marschieren in Paris ein", date: "14. Juni 1940" },
                        { id: 5, text: "Waffenstillstand mit Frankreich", date: "22. Juni 1940" }
                    ]},
                    { events: [
                        { id: 1, text: "Luftschlacht um England beginnt", date: "10. Juli 1940" },
                        { id: 2, text: "Dreim√§chtepakt Deutschland-Italien-Japan", date: "27. September 1940" },
                        { id: 3, text: "Deutsche Truppen in Nordafrika", date: "12. Februar 1941" },
                        { id: 4, text: "Beginn des Unternehmens Barbarossa", date: "22. Juni 1941" },
                        { id: 5, text: "Japanischer Angriff auf Pearl Harbor", date: "7. Dezember 1941" }
                    ]}
                ]
            },
            {
                id: 4, title: "Kriegswende und Ende", category: "Zweiter Weltkrieg", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Wannsee-Konferenz", date: "20. Januar 1942" },
                        { id: 2, text: "Beginn der Schlacht um Stalingrad", date: "23. August 1942" },
                        { id: 3, text: "Kapitulation in Stalingrad", date: "2. Februar 1943" },
                        { id: 4, text: "Goebbels' Sportpalastrede", date: "18. Februar 1943" },
                        { id: 5, text: "Hinrichtung der Geschwister Scholl", date: "22. Februar 1943" }
                    ]},
                    { events: [
                        { id: 1, text: "Alliierte Landung in der Normandie", date: "6. Juni 1944" },
                        { id: 2, text: "Attentat vom 20. Juli auf Hitler", date: "20. Juli 1944" },
                        { id: 3, text: "Befreiung von Paris", date: "25. August 1944" },
                        { id: 4, text: "Beginn der Ardennenoffensive", date: "16. Dezember 1944" },
                        { id: 5, text: "Konferenz von Jalta", date: "4.-11. Februar 1945" }
                    ]},
                    { events: [
                        { id: 1, text: "Zerst√∂rung Dresdens", date: "13./14. Februar 1945" },
                        { id: 2, text: "US-Truppen √ºberqueren Rhein bei Remagen", date: "7. M√§rz 1945" },
                        { id: 3, text: "Selbstmord Adolf Hitlers", date: "30. April 1945" },
                        { id: 4, text: "Bedingungslose Kapitulation", date: "8. Mai 1945" },
                        { id: 5, text: "Potsdamer Konferenz beginnt", date: "17. Juli 1945" }
                    ]}
                ]
            },
            {
                id: 5, title: "Nachkriegszeit und Teilung", category: "Nachkriegszeit", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "N√ºrnberger Prozesse beginnen", date: "20. November 1945" },
                        { id: 2, text: "Zwangsvereinigung zur SED", date: "21./22. April 1946" },
                        { id: 3, text: "Bizone gebildet", date: "1. Januar 1947" },
                        { id: 4, text: "Verk√ºndung der Truman-Doktrin", date: "12. M√§rz 1947" },
                        { id: 5, text: "Marshall-Plan angek√ºndigt", date: "5. Juni 1947" }
                    ]},
                    { events: [
                        { id: 1, text: "Londoner Sechsm√§chtekonferenz", date: "23. Februar 1948" },
                        { id: 2, text: "W√§hrungsreform in den Westzonen", date: "20. Juni 1948" },
                        { id: 3, text: "Beginn der Berlin-Blockade", date: "24. Juni 1948" },
                        { id: 4, text: "Parlamentarischer Rat tritt zusammen", date: "1. September 1948" },
                        { id: 5, text: "Ende der Berlin-Blockade", date: "12. Mai 1949" }
                    ]},
                    { events: [
                        { id: 1, text: "Verk√ºndung des Grundgesetzes", date: "23. Mai 1949" },
                        { id: 2, text: "Erste Bundestagswahl", date: "14. August 1949" },
                        { id: 3, text: "Adenauer wird erster Bundeskanzler", date: "15. September 1949" },
                        { id: 4, text: "Gr√ºndung der DDR", date: "7. Oktober 1949" },
                        { id: 5, text: "Wilhelm Pieck wird DDR-Pr√§sident", date: "11. Oktober 1949" }
                    ]}
                ]
            },
            {
                id: 6, title: "Mauerbau und Kalter Krieg", category: "Deutsche Teilung", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Beitritt der BRD zur NATO", date: "9. Mai 1955" },
                        { id: 2, text: "Gr√ºndung des Warschauer Pakts", date: "14. Mai 1955" },
                        { id: 3, text: "Gr√ºndung der Bundeswehr", date: "12. November 1955" },
                        { id: 4, text: "Chruschtschow-Ultimatum zu Berlin", date: "27. November 1958" },
                        { id: 5, text: "Wiener Gipfel Kennedy-Chruschtschow", date: "3./4. Juni 1961" }
                    ]},
                    { events: [
                        { id: 1, text: "Ulbricht: 'Niemand hat die Absicht...'", date: "15. Juni 1961" },
                        { id: 2, text: "Bau der Berliner Mauer beginnt", date: "13. August 1961" },
                        { id: 3, text: "Flucht Konrad Schumanns", date: "15. August 1961" },
                        { id: 4, text: "Checkpoint Charlie - Panzer-Konfrontation", date: "27. Oktober 1961" },
                        { id: 5, text: "Peter Fechter wird erschossen", date: "17. August 1962" }
                    ]},
                    { events: [
                        { id: 1, text: "Kennedy-Rede 'Ich bin ein Berliner'", date: "26. Juni 1963" },
                        { id: 2, text: "Erstes Passierscheinabkommen", date: "17. Dezember 1963" },
                        { id: 3, text: "Tunnel 57 - gr√∂√üte Massenflucht", date: "3./4. Oktober 1964" },
                        { id: 4, text: "Neues √ñkonomisches System in der DDR", date: "1963-1967" },
                        { id: 5, text: "Neue Verfassung der DDR", date: "6. April 1968" }
                    ]}
                ]
            },
            {
                id: 7, title: "Neue Ostpolitik", category: "Entspannung", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Willy Brandt wird Bundeskanzler", date: "21. Oktober 1969" },
                        { id: 2, text: "Treffen Brandt-Stoph in Erfurt", date: "19. M√§rz 1970" },
                        { id: 3, text: "Treffen Brandt-Stoph in Kassel", date: "21. Mai 1970" },
                        { id: 4, text: "Moskauer Vertrag unterzeichnet", date: "12. August 1970" },
                        { id: 5, text: "Kniefall von Warschau", date: "7. Dezember 1970" }
                    ]},
                    { events: [
                        { id: 1, text: "Vierm√§chteabkommen √ºber Berlin", date: "3. September 1971" },
                        { id: 2, text: "Transitabkommen BRD-DDR", date: "17. Dezember 1971" },
                        { id: 3, text: "Brandt erh√§lt Friedensnobelpreis", date: "10. Dezember 1971" },
                        { id: 4, text: "Verkehrsvertrag BRD-DDR", date: "26. Mai 1972" },
                        { id: 5, text: "Grundlagenvertrag BRD-DDR", date: "21. Dezember 1972" }
                    ]},
                    { events: [
                        { id: 1, text: "BRD und DDR werden UN-Mitglieder", date: "18. September 1973" },
                        { id: 2, text: "St√§ndige Vertretungen er√∂ffnet", date: "14. M√§rz 1974" },
                        { id: 3, text: "R√ºcktritt Brandts (Guillaume-Aff√§re)", date: "6. Mai 1974" },
                        { id: 4, text: "Helmut Schmidt wird Bundeskanzler", date: "16. Mai 1974" },
                        { id: 5, text: "KSZE-Schlussakte von Helsinki", date: "1. August 1975" }
                    ]}
                ]
            },
            {
                id: 8, title: "Friedliche Revolution 1989", category: "Wiedervereinigung", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Kommunalwahlen in der DDR - Wahlf√§lschung", date: "7. Mai 1989" },
                        { id: 2, text: "Massaker auf dem Tiananmen-Platz", date: "4. Juni 1989" },
                        { id: 3, text: "Paneurop√§isches Picknick", date: "19. August 1989" },
                        { id: 4, text: "Ungarn √∂ffnet Grenze zu √ñsterreich", date: "11. September 1989" },
                        { id: 5, text: "Neues Forum gegr√ºndet", date: "9./10. September 1989" }
                    ]},
                    { events: [
                        { id: 1, text: "Ausreise der Botschaftsfl√ºchtlinge aus Prag", date: "30. September 1989" },
                        { id: 2, text: "40. Jahrestag der DDR - Proteste", date: "7. Oktober 1989" },
                        { id: 3, text: "Montagsdemonstration Leipzig - 70.000", date: "9. Oktober 1989" },
                        { id: 4, text: "R√ºcktritt Erich Honeckers", date: "18. Oktober 1989" },
                        { id: 5, text: "Egon Krenz wird SED-Generalsekret√§r", date: "18. Oktober 1989" }
                    ]},
                    { events: [
                        { id: 1, text: "Gro√üdemonstration auf dem Alexanderplatz", date: "4. November 1989" },
                        { id: 2, text: "DDR-Regierung tritt zur√ºck", date: "7. November 1989" },
                        { id: 3, text: "Schabowskis Pressekonferenz", date: "9. November 1989, 18:53" },
                        { id: 4, text: "Fall der Berliner Mauer", date: "9. November 1989, 23:30" },
                        { id: 5, text: "√ñffnung des Brandenburger Tors", date: "22. Dezember 1989" }
                    ]}
                ]
            },
            {
                id: 9, title: "Deutsche Einheit 1990", category: "Wiedervereinigung", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Kohl pr√§sentiert Zehn-Punkte-Programm", date: "28. November 1989" },
                        { id: 2, text: "Runder Tisch konstituiert sich", date: "7. Dezember 1989" },
                        { id: 3, text: "Hans Modrow wird DDR-Ministerpr√§sident", date: "13. November 1989" },
                        { id: 4, text: "Beginn der Zwei-plus-Vier-Gespr√§che", date: "13. Februar 1990" },
                        { id: 5, text: "Erste freie Volkskammerwahl", date: "18. M√§rz 1990" }
                    ]},
                    { events: [
                        { id: 1, text: "Lothar de Maizi√®re wird Ministerpr√§sident", date: "12. April 1990" },
                        { id: 2, text: "Staatsvertrag √ºber W√§hrungsunion", date: "18. Mai 1990" },
                        { id: 3, text: "W√§hrungs-, Wirtschafts- und Sozialunion", date: "1. Juli 1990" },
                        { id: 4, text: "Einigungsvertrag unterzeichnet", date: "31. August 1990" },
                        { id: 5, text: "Zwei-plus-Vier-Vertrag unterzeichnet", date: "12. September 1990" }
                    ]},
                    { events: [
                        { id: 1, text: "Volkskammer beschlie√üt DDR-Beitritt", date: "23. August 1990" },
                        { id: 2, text: "Deutsche Wiedervereinigung", date: "3. Oktober 1990" },
                        { id: 3, text: "Erste gesamtdeutsche Bundestagswahl", date: "2. Dezember 1990" },
                        { id: 4, text: "Kohl wird gesamtdeutscher Kanzler", date: "17. Januar 1991" },
                        { id: 5, text: "Bundestag beschlie√üt Berlin als Hauptstadt", date: "20. Juni 1991" }
                    ]}
                ]
            },
            {
                id: 10, title: "Kaiserreich und Bismarck", category: "Kaiserreich", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Emser Depesche ver√∂ffentlicht", date: "13. Juli 1870" },
                        { id: 2, text: "Schlacht bei Sedan", date: "2. September 1870" },
                        { id: 3, text: "Kaiserproklamation in Versailles", date: "18. Januar 1871" },
                        { id: 4, text: "Reichsverfassung tritt in Kraft", date: "16. April 1871" },
                        { id: 5, text: "Frankfurter Friedensvertrag", date: "10. Mai 1871" }
                    ]},
                    { events: [
                        { id: 1, text: "Kanzelparagraph", date: "10. Dezember 1871" },
                        { id: 2, text: "Jesuitengesetz", date: "4. Juli 1872" },
                        { id: 3, text: "Maigesetze gegen katholische Kirche", date: "Mai 1873" },
                        { id: 4, text: "Attentat auf Bismarck", date: "13. Juli 1874" },
                        { id: 5, text: "Ende des Kulturkampfs beginnt", date: "1878" }
                    ]},
                    { events: [
                        { id: 1, text: "Sozialistengesetz tritt in Kraft", date: "21. Oktober 1878" },
                        { id: 2, text: "Krankenversicherungsgesetz", date: "15. Juni 1883" },
                        { id: 3, text: "Unfallversicherungsgesetz", date: "6. Juli 1884" },
                        { id: 4, text: "Alters- und Invalidenversicherung", date: "22. Juni 1889" },
                        { id: 5, text: "Entlassung Bismarcks", date: "20. M√§rz 1890" }
                    ]}
                ]
            },
            {
                id: 11, title: "Erster Weltkrieg", category: "Erster Weltkrieg", difficulty: 4,
                attempts: [
                    { events: [
                        { id: 1, text: "Attentat von Sarajevo", date: "28. Juni 1914" },
                        { id: 2, text: "√ñsterreichisches Ultimatum an Serbien", date: "23. Juli 1914" },
                        { id: 3, text: "√ñsterreich erkl√§rt Serbien den Krieg", date: "28. Juli 1914" },
                        { id: 4, text: "Deutsche Kriegserkl√§rung an Russland", date: "1. August 1914" },
                        { id: 5, text: "Deutsche Kriegserkl√§rung an Frankreich", date: "3. August 1914" }
                    ]},
                    { events: [
                        { id: 1, text: "Schlacht an der Marne", date: "5.-12. September 1914" },
                        { id: 2, text: "Beginn des U-Boot-Kriegs", date: "1. Februar 1917" },
                        { id: 3, text: "Kriegseintritt der USA", date: "6. April 1917" },
                        { id: 4, text: "Waffenstillstand mit Russland", date: "15. Dezember 1917" },
                        { id: 5, text: "Deutsche Fr√ºhjahrsoffensive", date: "21. M√§rz 1918" }
                    ]},
                    { events: [
                        { id: 1, text: "OHL fordert Waffenstillstand", date: "29. September 1918" },
                        { id: 2, text: "Matrosenaufstand in Kiel", date: "3. November 1918" },
                        { id: 3, text: "Abdankung Kaiser Wilhelms II.", date: "9. November 1918" },
                        { id: 4, text: "Waffenstillstand von Compi√®gne", date: "11. November 1918" },
                        { id: 5, text: "Versailler Vertrag unterzeichnet", date: "28. Juni 1919" }
                    ]}
                ]
            },
            {
                id: 12, title: "Revolution 1848/49", category: "Revolution 1848", difficulty: 3,
                attempts: [
                    { events: [
                        { id: 1, text: "Februarrevolution in Frankreich", date: "22.-24. Februar 1848" },
                        { id: 2, text: "Mannheimer Volksversammlung", date: "27. Februar 1848" },
                        { id: 3, text: "M√§rzforderungen in Baden", date: "1. M√§rz 1848" },
                        { id: 4, text: "Barrikadenk√§mpfe in Berlin", date: "18./19. M√§rz 1848" },
                        { id: 5, text: "Er√∂ffnung des Vorparlaments", date: "31. M√§rz 1848" }
                    ]},
                    { events: [
                        { id: 1, text: "Er√∂ffnung der Nationalversammlung", date: "18. Mai 1848" },
                        { id: 2, text: "Heinrich von Gagern wird Pr√§sident", date: "19. Mai 1848" },
                        { id: 3, text: "Waffenstillstand von Malm√∂", date: "26. August 1848" },
                        { id: 4, text: "Septemberunruhen in Frankfurt", date: "18. September 1848" },
                        { id: 5, text: "Grundrechte des deutschen Volkes", date: "27. Dezember 1848" }
                    ]},
                    { events: [
                        { id: 1, text: "Verabschiedung der Paulskirchenverfassung", date: "28. M√§rz 1849" },
                        { id: 2, text: "Friedrich Wilhelm IV. lehnt Kaiserkrone ab", date: "3. April 1849" },
                        { id: 3, text: "Maiaufst√§nde in Dresden und Baden", date: "Mai 1849" },
                        { id: 4, text: "Rumpfparlament tagt in Stuttgart", date: "6.-18. Juni 1849" },
                        { id: 5, text: "Niederschlagung der badischen Aufst√§nde", date: "23. Juli 1849" }
                    ]}
                ]
            }
        ];

        let currentUser = null;
        let currentRound = null;
        let currentAttempt = 1;
        let roundPoints = [0, 0, 0];
        let draggedElement = null;
        let userDailyRounds = [];

        const STORAGE_KEYS = {
            LEADERBOARD: 'historyQuiz_lb_v5',
            DAILY_ROUNDS: 'historyQuiz_dr_v5'
        };

        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            setupLoginForm();
        });

        function checkSession() {
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) { currentUser = savedUser; showMainApp(); }
        }

        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                if (password === CORRECT_PASSWORD) {
                    currentUser = username;
                    sessionStorage.setItem('currentUser', username);
                    showMainApp();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('password').value = '';
                }
            });
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('displayName').textContent = currentUser;
            generateDailyRounds();
            updateDailyPlays();
            renderRounds();
            renderLeaderboard();
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function generateDailyRounds() {
            const today = new Date().toDateString();
            const storageKey = `${STORAGE_KEYS.DAILY_ROUNDS}_${currentUser}`;
            const stored = JSON.parse(localStorage.getItem(storageKey) || '{}');
            if (stored.date === today && stored.rounds) { userDailyRounds = stored.rounds; return; }
            const seed = hashCode(today + currentUser);
            const shuffled = seededShuffle([...allQuizRounds], seed);
            userDailyRounds = shuffled.slice(0, 3).map((round, index) => ({ ...round, dailyIndex: index + 1 }));
            localStorage.setItem(storageKey, JSON.stringify({ date: today, rounds: userDailyRounds }));
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash = hash & hash; }
            return Math.abs(hash);
        }

        function seededRandom(seed) { const x = Math.sin(seed++) * 10000; return x - Math.floor(x); }

        function seededShuffle(array, seed) {
            const result = [...array];
            for (let i = result.length - 1; i > 0; i--) { const j = Math.floor(seededRandom(seed + i) * (i + 1)); [result[i], result[j]] = [result[j], result[i]]; }
            return result;
        }

        function showSection(section) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            ['roundsSection', 'quizSection', 'resultSection', 'finalResultSection', 'leaderboardSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (section === 'rounds') { document.getElementById('roundsSection').classList.remove('hidden'); renderRounds(); }
            else if (section === 'leaderboard') { document.getElementById('leaderboardSection').classList.remove('hidden'); renderLeaderboard(); }
        }

        function getDailyPlays() {
            const today = new Date().toDateString();
            const data = JSON.parse(localStorage.getItem(`dp_v5_${currentUser}`) || '{}');
            if (data.date !== today) { return { date: today, plays: 0, completedRoundIds: [], scores: {} }; }
            return data;
        }

        function saveDailyPlays(data) { localStorage.setItem(`dp_v5_${currentUser}`, JSON.stringify(data)); }
        function updateDailyPlays() { const dailyData = getDailyPlays(); document.getElementById('dailyPlays').textContent = `Heute: ${dailyData.plays}/${MAX_DAILY_ROUNDS} Runden`; }

        function renderRounds() {
            const grid = document.getElementById('roundsGrid');
            const dailyData = getDailyPlays();
            grid.innerHTML = userDailyRounds.map((round, index) => {
                const isCompleted = dailyData.completedRoundIds?.includes(round.id);
                const score = dailyData.scores?.[round.id];
                const difficultyDots = Array(5).fill(0).map((_, i) => `<span class="difficulty-dot ${i < round.difficulty ? 'active' : ''}"></span>`).join('');
                return `<div class="round-card ${isCompleted ? 'completed' : ''}" onclick="${isCompleted ? 'showToast(\"Diese Runde hast du heute bereits gespielt.\", \"error\")' : `startRound(${index})`}">
                    <span class="round-status">${isCompleted ? '‚úì' : '‚ñ∂Ô∏è'}</span>
                    <div class="round-number">Runde ${index + 1} von 3</div>
                    <div class="round-title">${round.title}</div>
                    <div class="round-date">üìÅ ${round.category}</div>
                    <div class="difficulty">Schwierigkeit: <span class="difficulty-dots">${difficultyDots}</span></div>
                    ${isCompleted ? `<span class="score-badge">‚úì ${score} Punkte</span>` : ''}
                </div>`;
            }).join('');
        }

        function startRound(roundIndex) {
            currentRound = userDailyRounds[roundIndex];
            currentAttempt = 1;
            roundPoints = [0, 0, 0];
            document.getElementById('roundsSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            loadAttempt();
        }

        function loadAttempt() {
            document.getElementById('quizTitle').innerHTML = `üìú ${currentRound.title}`;
            document.getElementById('attemptNumber').textContent = `${currentAttempt}/3`;
            document.getElementById('attemptBadge').textContent = `Durchlauf ${currentAttempt} von 3`;
            document.getElementById('currentPoints').textContent = roundPoints.reduce((a, b) => a + b, 0);
            document.getElementById('progressFill').style.width = `${(currentAttempt / 3) * 100}%`;
            const attemptEvents = currentRound.attempts[currentAttempt - 1].events;
            const shuffledEvents = [...attemptEvents].sort(() => Math.random() - 0.5);
            renderEvents(shuffledEvents);
        }

        function renderEvents(events) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = events.map((event, index) => `<div class="event-item" draggable="true" data-id="${event.id}">
                <span class="drag-handle">‚ò∞</span>
                <span class="event-number">${index + 1}</span>
                <span class="event-text">${event.text}</span>
            </div>`).join('');
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const items = document.querySelectorAll('.event-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            });
        }

        function handleDragStart(e) { draggedElement = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragEnd() { this.classList.remove('dragging'); updateNumbers(); }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDrop(e) {
            e.preventDefault();
            if (draggedElement !== this) {
                const container = document.getElementById('eventsContainer');
                const items = [...container.querySelectorAll('.event-item')];
                const draggedIndex = items.indexOf(draggedElement);
                const dropIndex = items.indexOf(this);
                if (draggedIndex < dropIndex) { this.parentNode.insertBefore(draggedElement, this.nextSibling); }
                else { this.parentNode.insertBefore(draggedElement, this); }
            }
            updateNumbers();
        }

        let touchedElement = null;
        function handleTouchStart(e) { touchedElement = this; this.classList.add('dragging'); }
        function handleTouchMove(e) {
            e.preventDefault();
            const touchY = e.touches[0].clientY;
            const container = document.getElementById('eventsContainer');
            const items = [...container.querySelectorAll('.event-item')];
            items.forEach(item => {
                if (item !== touchedElement) {
                    const rect = item.getBoundingClientRect();
                    if (touchY > rect.top && touchY < rect.bottom) {
                        const midpoint = rect.top + rect.height / 2;
                        if (touchY < midpoint) { container.insertBefore(touchedElement, item); }
                        else { container.insertBefore(touchedElement, item.nextSibling); }
                    }
                }
            });
        }
        function handleTouchEnd() { if (touchedElement) { touchedElement.classList.remove('dragging'); touchedElement = null; } updateNumbers(); }
        function updateNumbers() { document.querySelectorAll('.event-item').forEach((item, index) => { item.querySelector('.event-number').textContent = index + 1; }); }

        function submitAnswer() {
            const items = document.querySelectorAll('.event-item');
            const userOrder = [...items].map(item => parseInt(item.dataset.id));
            const attemptEvents = currentRound.attempts[currentAttempt - 1].events;
            const correctOrder = attemptEvents.map(e => e.id);
            let correctCount = 0;
            let firstCorrect = userOrder[0] === correctOrder[0];
            let lastCorrect = userOrder[4] === correctOrder[4];
            items.forEach((item, index) => {
                const userId = parseInt(item.dataset.id);
                const isCorrect = userId === correctOrder[index];
                if (isCorrect) { correctCount++; item.classList.add('correct'); item.classList.remove('incorrect'); }
                else { item.classList.add('incorrect'); item.classList.remove('correct'); }
            });
            let attemptScore = 0;
            if (correctCount === 5) attemptScore = POINTS_PER_CORRECT;
            if (firstCorrect) attemptScore += BONUS_FIRST_LAST;
            if (lastCorrect) attemptScore += BONUS_FIRST_LAST;
            roundPoints[currentAttempt - 1] = attemptScore;
            setTimeout(() => showAttemptResult(correctCount, firstCorrect, lastCorrect, attemptScore), 1000);
        }

        function showAttemptResult(correctCount, firstCorrect, lastCorrect, attemptScore) {
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            const iconEl = document.getElementById('resultIcon');
            const titleEl = document.getElementById('resultTitle');
            if (correctCount === 5) { iconEl.className = 'result-icon success'; iconEl.textContent = 'üéâ'; titleEl.textContent = 'Perfekt!'; }
            else if (correctCount >= 3) { iconEl.className = 'result-icon partial'; iconEl.textContent = 'üëç'; titleEl.textContent = 'Gut gemacht!'; }
            else { iconEl.className = 'result-icon fail'; iconEl.textContent = 'üìö'; titleEl.textContent = 'Weiter √ºben!'; }
            document.getElementById('resultSubtitle').textContent = `Du hast ${correctCount} von 5 Ereignissen richtig eingeordnet.`;
            const stars = correctCount === 5 ? '‚≠ê‚≠ê‚≠ê' : (correctCount >= 3 ? '‚≠ê‚≠ê' : (correctCount >= 1 ? '‚≠ê' : ''));
            document.getElementById('resultStars').textContent = stars || '‚Äî';
            document.getElementById('correctCount').textContent = `${correctCount}/5`;
            document.getElementById('firstBonus').textContent = firstCorrect ? '+1' : '0';
            document.getElementById('firstBonus').style.color = firstCorrect ? 'var(--success)' : 'var(--error)';
            document.getElementById('lastBonus').textContent = lastCorrect ? '+1' : '0';
            document.getElementById('lastBonus').style.color = lastCorrect ? 'var(--success)' : 'var(--error)';
            document.getElementById('attemptPoints').textContent = attemptScore;
            const attemptEvents = currentRound.attempts[currentAttempt - 1].events;
            document.getElementById('correctOrderList').innerHTML = attemptEvents.map((event, index) => `<div class="correct-item">
                <span class="number">${index + 1}</span>
                <span class="event-name">${event.text}</span>
                <span class="event-date">${event.date}</span>
            </div>`).join('');
            document.getElementById('continueBtn').textContent = currentAttempt < 3 ? `Weiter zu Durchlauf ${currentAttempt + 1}` : 'Runde abschlie√üen';
        }

        function continueQuiz() {
            if (currentAttempt < 3) { currentAttempt++; document.getElementById('resultSection').classList.add('hidden'); document.getElementById('quizSection').classList.remove('hidden'); loadAttempt(); }
            else { showFinalResult(); }
        }

        function showFinalResult() {
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('finalResultSection').classList.remove('hidden');
            const totalPoints = roundPoints.reduce((a, b) => a + b, 0);
            document.getElementById('attempt1Score').textContent = `${roundPoints[0]} Punkte`;
            document.getElementById('attempt2Score').textContent = `${roundPoints[1]} Punkte`;
            document.getElementById('attempt3Score').textContent = `${roundPoints[2]} Punkte`;
            document.getElementById('totalRoundScore').textContent = `${totalPoints} Punkte`;
            const iconEl = document.getElementById('finalResultIcon');
            if (totalPoints >= 12) { iconEl.className = 'result-icon success'; iconEl.textContent = 'üèÜ'; }
            else if (totalPoints >= 6) { iconEl.className = 'result-icon partial'; iconEl.textContent = 'üéñÔ∏è'; }
            else { iconEl.className = 'result-icon fail'; iconEl.textContent = 'üìñ'; }
            document.getElementById('finalResultSubtitle').textContent = `Du hast insgesamt ${totalPoints} von ${MAX_POINTS_PER_ROUND} m√∂glichen Punkten erreicht.`;
            saveRoundProgress(totalPoints);
            updateLeaderboard(totalPoints);
        }

        function saveRoundProgress(totalPoints) {
            const dailyData = getDailyPlays();
            dailyData.plays = (dailyData.plays || 0) + 1;
            dailyData.completedRoundIds = dailyData.completedRoundIds || [];
            dailyData.completedRoundIds.push(currentRound.id);
            dailyData.scores = dailyData.scores || {};
            dailyData.scores[currentRound.id] = totalPoints;
            dailyData.date = new Date().toDateString();
            saveDailyPlays(dailyData);
            updateDailyPlays();
        }

        function backToRounds() {
            document.getElementById('finalResultSection').classList.add('hidden');
            document.getElementById('roundsSection').classList.remove('hidden');
            renderRounds();
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.nav-tab').classList.add('active');
        }

        function updateLeaderboard(newPoints) {
            const leaderboard = JSON.parse(localStorage.getItem(STORAGE_KEYS.LEADERBOARD) || '[]');
            const existingEntry = leaderboard.find(e => e.username === currentUser);
            if (existingEntry) { existingEntry.points += newPoints; existingEntry.rounds++; existingEntry.average = existingEntry.points / existingEntry.rounds; }
            else { leaderboard.push({ username: currentUser, points: newPoints, rounds: 1, average: newPoints }); }
            leaderboard.sort((a, b) => b.points - a.points);
            localStorage.setItem(STORAGE_KEYS.LEADERBOARD, JSON.stringify(leaderboard.slice(0, 50)));
            renderLeaderboard();
        }

        function renderLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem(STORAGE_KEYS.LEADERBOARD) || '[]');
            const tbody = document.getElementById('leaderboardBody');
            if (leaderboard.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">Noch keine Eintr√§ge.</td></tr>`; return; }
            tbody.innerHTML = leaderboard.map((entry, index) => {
                const rank = index + 1;
                const isCurrentUser = entry.username === currentUser;
                const rankClass = rank === 1 ? 'rank-1' : (rank === 2 ? 'rank-2' : (rank === 3 ? 'rank-3' : ''));
                const avgFormatted = entry.average.toFixed(1).replace('.', ',');
                return `<tr class="${isCurrentUser ? 'current-user' : ''}">
                    <td class="rank ${rankClass}">${rank}</td>
                    <td class="username">${entry.username}</td>
                    <td>${entry.points}</td>
                    <td>${entry.rounds}</td>
                    <td>${avgFormatted}</td>
                </tr>`;
            }).join('');
        }

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
